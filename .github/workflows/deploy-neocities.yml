name: Deploy to Neocities

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: neocities
      url: ${{ steps.site.outputs.url }}
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Read site URL
        id: site
        run: |
          python - <<'PY'
          import json
          import os

          url = ""
          try:
            with open("content/index.json", "r", encoding="utf-8") as handle:
              data = json.load(handle)
              url = data.get("site", {}).get("url", "")
          except FileNotFoundError:
            pass

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as handle:
            handle.write(f"url={url}\n")
          PY

      - name: Deploy to Neocities
        env:
          NEOCITIES_API_KEY: ${{ secrets.NEOCITIES_API_KEY }}
        run: |
          set -euo pipefail
          if [ -z "${NEOCITIES_API_KEY:-}" ]; then
            echo "NEOCITIES_API_KEY is not set; skipping deploy."
            exit 0
          fi
          api_url="https://neocities.org/api/upload"

          git ls-files -co --exclude-standard -z | while IFS= read -r -d '' file; do
            echo "Uploading ${file}"
            curl --fail --silent --show-error \
              -H "Authorization: Bearer ${NEOCITIES_API_KEY}" \
              -F "file=@${file};filename=${file}" \
              "${api_url}" >/dev/null
          done
